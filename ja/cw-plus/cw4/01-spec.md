# CW4仕様:グループメンバーシップ

cw4パッケージのソースコード:[https://github.com/CosmWasm/cosmwasm-plus/blob/master/packages/cw4/README.md](https://github.com/CosmWasm/cosmwasm-plus/blob/master/packages/cw4/README.md)

CW4は、ストレージグループメンバーの仕様であり、組み合わせることができます
CW3マルチシグニチャを使用します。目的は、メンバー/投票者のセットを保存することです
別のパーツの権限を判別するためにアクセスできます。

これは通常、コントラクトペアとして展開されるため、これを期待します
`QueryRaw`と内部クエリコントラクトの頻繁な使用
一部のデータ構造のレイアウトは、パブリックAPIの一部になります。
実装によりデータ構造が追加される場合がありますが、少なくとも
ここにリストされているものは、指定されたキーの下にあり、
同じフォーマット。

この場合、cw3コントラクトは外部の組み合わせを
ローカルストレージを読み取るよりもコストはかかりません。ただし、更新
グループ契約(許可されている場合)は外部メッセージになり、
契約ごとにインスタンス化コストを請求します。

## 情報

グループの設定を容易にするために、 `InitMsg {admin、members}`を定義します
別のプロセスの一部として。実装はこの設定で機能するはずです、
ただし、不要な拡張機能のために、追加の `Option <T>`フィールドが追加される場合があります
構成は `init`フェーズで行われます。

グループ契約は、次の3種類のメッセージをサポートします。

`UpdateAdmin {admin}`-契約の管理者を変更(またはクリア)します

`AddHook {addr}`-契約アドレスを追加します。各アドレスが呼び出されます
`UpdateMembers`呼び出し。これは管理者のみが呼び出すことができ、注意する必要があります
連れ去られた。エラーを返したり、ガスが不足したりする契約は
メンバーシップの変更を元に戻します(以下の「フック」セクションの詳細を参照してください)。

`RemoveHook {addr}`-以前に設定された契約アドレスをキャンセルします
`AddHook`経由。

これらの機能を実行できるのは `admin`だけです。したがって、1つを省略することによって
`admin`、私たちはついに同様の機能広告` cw3-fixed-multisig`を手に入れました。
これを含めると、通常は「cw3」契約であると予想されます
このグループ契約をグループとして使用します。これはいくつかの鶏と卵をもたらしました
質問ですが、その方法を示しました
[`cw3-flexible-multisig`](../cw3/03-cw3-flex-spec.md)

## お問い合わせ

### 頭がいい

`TotalWeight {}`-現在のすべてのメンバーの合計の重みを返します。
これは、特定の条件が「メンバーのパーセンテージ」で定義されている場合に非常に役立ちます。

`Member {addr、height}`-投票者のメンバーである場合は、投票者の重みを返します
グループ(0の場合もあります)。グループのメンバーでない場合は「なし」です。
高さが設定されていて、cw4実装がスナップショットをサポートしている場合、
これにより、メンバーの重量が返されます
指定された高さのブロックの始まり。

`MemberList {start_after、limit}`-リストをページ分割できます
全員。 0の加重メンバーが含まれます。削除されたメンバーはしません。

`Admin {}` -`admin`のアドレスを返します。設定されていない場合は `None`を返します。

### 生

パブリックAPIを構成する上記の「SmartQueries」に加えて、
効率を向上させるために設計された2つの元のクエリを定義しました
契約コールで。これらは `cw4`によって派生したキーを使用します

`TOTAL_KEY`-元のクエリにこのキー(` b "total" `)を使用すると、
JSONでエンコードされた `u64`

`members_key()` -` CanonicalAddr`を受け入れ、
元のクエリの場合( `" \ x00 \ x07members "|| addr`)。これは戻ります
メンバーがグループに含まれていない場合はヌルバイトであり、そうでない場合はヌルバイトです。
JSONでエンコードされた `u64`

## 針

`cw4`コントラクトの特徴は、管理者が許可することです
複数のフックを登録します。これらは、対応する必要のある特別な契約です
グループメンバーシップが変更され、同期が維持されます。
これは強力な能力であることに再度注意してください。フックのみを設定する必要があります
完全に信頼できる契約、通常は展開するいくつかの契約
グループで。

コントラクトがcw4コントラクトのフックとして登録されている場合は、いつでも
`UpdateMembers`が正常に実行され、フックは` handle`を受け取ります
次の形式を使用して呼び出します。

```json
{
  "member_changed_hook": {
    "diffs": [
      {
        "addr": "cosmos1y3x7q772u8s25c5zve949fhanrhvmtnu484l8z",
        "old_weight": 20,
        "new_weight": 24
      }
    ]
  }
}
```

詳細については、[hook.rs](https://github.com/CosmWasm/cosmwasm-plus/blob/master/packages/cw4/src/hook.rs)を参照してください。 この例に注意してください
更新されたメンバーまたは既存のメンバーを表示します。 `old_weight`は
初めてアドレスを追加すると、アドレスは失われます。 と
アドレスを削除すると、 `new_weight`は失われます。

受信側のコントラクトは `MemberChangedHookMsg`を処理できる必要があります
そして、関数を変更したい場合にのみエラーを返します
グループ契約(例:マルチシグニチャメンバーシップを防止したい
公の提案がある場合は変更してください)。 しかし、そのような場合はかなりです
まれで、しばしば壊れやすいコードを指します。

メッセージの送信者は、更新された組み合わせと同じになることに注意してください。
外部の参加者ができないように、処理するときにこれを必ず確認してください
このフックを、信頼できるグループのみと呼びます。
